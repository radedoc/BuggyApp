<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HTML</title>
    <style>
        #editor {
                position: absolute;
                top: 0;
                right: 50%;
                bottom: 0;
                left: 0;
            }
        #snippet {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 50%;
        }

    </style>
</head>
<body>
  <div class="container">

        <div id="editor" class="col-md-6"></div>
        <div id="codesnippet">
          <p id="snippet"></p>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
        <script>
          var editor = ace.edit("editor");
          editor.setTheme("ace/theme/monokai");
          editor.getSession().setMode("ace/mode/python");
          var listening = false


          // var recognition = new webkitSpeechRecognition();
          // recognition.continuous = true;
          // recognition.interimResults = true;
          // recognition.onresult = function(event) {
          //   console.log(event)
          // }
          // recognition.start();

          // var string = "print quote Hello World quote"

          var compiler = function(data, editor){


            var messages = data.split(" ");


            for (i = 0; i < messages.length; i++){

              if ((messages[i] == 'buggy') && ((i + 2) < messages.length)){
                if ((messages[i+1] == "start") && (messages[i+2] == 'listening')){
                  listening = true;

                }
                else if ((messages[i+1] == "stop") && (messages[i+2] == 'listening')){
                  listening = false;

                }
                else if (messages[i+1] == "search") {
                  var query = "";
                  for (j = i + 1; j < messages.length; j++){
                    query += messages[j] + ' ';
                  }
                  document.getElementById("snippet").innerHTML+=query + '\n';
                  fetch(query);
                  break;
                }
              }

              if (listening){

                if (messages[i] == "quote"){
                  editor.insert("\"");
                }
                else if (messages[i] == 'enter'){
                  editor.insert('\n');
                }
                else if (messages[i] == 'space'){
                  editor.navigateDown(1);
                }
                else if (messages[i] == 'delete'){
                  editor.removeWordLeft();
                }
                else if (messages[i] == 'clear') {
                  editor.removeToLineStart();
                }
                else{
                  editor.insert(messages[i]+' ');
                }

              }


            }


          }

          if (!('webkitSpeechRecognition' in window)) {
            upgrade();
          } else {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onerror = function(event) { console.log("oops") }
            recognition.onend = function() { recognition.start() }
            recognition.onresult = function(event) {
            compiler(event.results[0][0].transcript, editor);
          };
        }

          console.log("Hello World")
          recognition.start()

          var request = require('request');
          var cheerio = require('cheerio');
          var google = require('google');

          function fetch(arg) {
            console.log(arg)
	           let query = arg
	           let language = "python"
	           newsearch(query, language).then((url) => {
	              console.log('Found google results!')
	              console.log(url)
	               return download(url)
	              }).then((html) => {
	  	              let answer = scrape(html)
	  	                if (answer === '') {
	                       document.getElementById("snippet").innerHTML='No answer found :('
	                      }
                         else {
	                          document.getElementById("snippet").innerHTML='Found snippet!'
	                          document.getElementById("snippet").innerHTML=answer +'\n';
	                       }
	                      }).catch((error) => {
	                         console.log(error.reason)
	                        })
                        }

                        function newsearch(query, language) {
                          return new Promise((resolve, reject) => {
                            let searchString = `${query} in ${language} site:stackoverflow.com`
                              console.log(searchString)
                            google(searchString, (err, res) => {
                            if (err) {
                            reject({
                            reason: 'A search error has occured :('
                          })
                        } else if (res.links.length === 0) {
                          reject({
                            reason: 'No results found :('
                          })
                        } else {
                          resolve(res.links[0].href)
                        }
                      })
                    })
                  }

                  function scrape(html) {
                    $ = cheerio.load(html)
                    return $('div.accepted-answer pre code').text()
                  }

                  function download(url) {
                  return new Promise((resolve, reject) => {
                    request(url, (error, response, body) => {
                      if (!error && response.statusCode == 200) {
                        resolve(body)
                      } else {
                        reject({
                          reason: 'Unable to download page'
                        })
                      }
                    })
                  })
                }

        </script>
  </div>
</body>
</html>
